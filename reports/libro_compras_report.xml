<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Acción del reporte -->
        <record id="report_libro_compras" model="ir.actions.report">
            <field name="name">Libro de Compras</field>
            <field name="model">libro.compras.periodo</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">libros_fiscales.report_libro_compras_template</field>
            <field name="print_report_name">'Libro de Compras - ' + (object.periodo or 'sin fecha')</field>
            <field name="binding_model_id" ref="model_libro_compras_periodo"/>
            <field name="binding_type">report</field>
            <field name="paperformat_id" ref="libros_fiscales.paperformat_libro_ventas_landscape"/>
        </record>

        <!-- Template del reporte -->
        <template id="report_libro_compras_template">
            <t t-call="web.html_container">
                <div class="page" style="font-family: Arial, sans-serif; font-size: 10pt; page-size: landscape; margin: 0.5cm;">
                    <meta charset="UTF-8"/>
                    <style>
                        @page {
                            size: letter landscape;
                            margin: 0.5cm;
                        }
                        body { margin: 0; }
                    </style>

                    <!-- ENCABEZADO -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 14pt; font-weight: bold;">LIBRO DE COMPRAS A CONTRIBUYENTES</h2>
                        <p style="margin: 5px 0; font-size: 11pt;">
                            <t t-if="docs">
                                PERÍODO: <t t-esc="docs[0].periodo or ''"/>
                            </t>
                        </p>
                    </div>

                    <!-- DATOS DE LA EMPRESA -->
                    <div style="text-align: center; margin-bottom: 10px;">
                        <t t-if="docs">
                            <t t-set="company" t-value="docs[0].company_id.parent_id if docs[0].incluir_sucursales and docs[0].company_id.parent_id else docs[0].company_id"/>
                            <p style="margin: 2px 0; font-weight: bold;">
                                <t t-esc="company.name or ''"/>
                            </p>
                            <p style="margin: 2px 0;">
                                NRC: <t t-esc="company.partner_id.l10n_sv_nrc or '---'"/>
                                - NIT: <t t-esc="company.vat or '---'"/>
                        </p>
                        <p style="margin: 2px 0;">EXPRESADO EN DÓLARES DE LOS ESTADOS UNIDOS DE AMÉRICA</p>
                    </t>
                </div>

                <!-- TABLA PRINCIPAL -->
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 9pt;" border="1">
                    <thead>
                        <tr style="background-color: #CCCCCC; font-weight: bold; text-align: center;">
                            <th style="border: 1px solid #000; padding: 4px; width: 4%;">No.</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">FECHA</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 10%;">REFERENCIA</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 25%;">PROVEEDOR</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 10%;">NIT</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">NRC</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">EXENTAS INT.</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">GRAVADAS INT.</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">EXENTAS IMP.</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 8%;">GRAVADAS IMP.</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 7%;">IVA RETENIDO</th>
                            <th style="border: 1px solid #000; padding: 4px; width: 7%;">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="contador" t-value="1"/>
                        <t t-foreach="docs[0].invoice_line_ids" t-as="line">
                            <tr style="text-align: center;">
                                <td style="border: 1px solid #000; padding: 3px;">
                                    <t t-esc="line.sequence"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px;">
                                    <t t-esc="line.invoice_date"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px;">
                                    <t t-esc="line.numero_documento or ''"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: left;">
                                    <t t-esc="line.partner_id.name or ''"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px;">
                                    <t t-esc="line.partner_id.vat or ''"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px;">
                                    <t t-esc="line.partner_id.l10n_sv_nrc or ''"/>
                                </td>

                                <!-- MONTOS -->
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$                                    <t t-esc="'%.2f' % (line.compras_internas_exentas or 0)"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$                                    <t t-esc="'%.2f' % (line.compras_internas_gravadas or 0)"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$ 0.00</td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$ 0.00</td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$                                    <t t-esc="'%.2f' % (line.credito_fiscal or 0)"/>
                                </td>
                                <td style="border: 1px solid #000; padding: 3px; text-align: right;">$                                    <t t-esc="'%.2f' % (line.amount_total or 0)"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <!-- TOTALES -->
                <t t-set="total_exentas_int" t-value="sum(line.compras_internas_exentas for line in docs[0].invoice_line_ids)"/>
                <t t-set="total_gravadas_int" t-value="sum(line.compras_internas_gravadas for line in docs[0].invoice_line_ids)"/>
                <t t-set="total_exentas_imp" t-value="0.0"/>
                <t t-set="total_gravadas_imp" t-value="0.0"/>
                <t t-set="total_iva" t-value="sum(line.credito_fiscal for line in docs[0].invoice_line_ids)"/>
                <t t-set="total_general" t-value="sum(line.amount_total for line in docs[0].invoice_line_ids)"/>

                <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt; font-weight: bold;" border="1">
                    <tr style="background-color: #CCCCCC;">
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;" colspan="6">TOTAL GENERAL</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_exentas_int"/>
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_gravadas_int"/>
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_exentas_imp"/>
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_gravadas_imp"/>
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_iva"/>
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: right;">$                            <t t-esc="'%.2f' % total_general"/>
                        </td>
                    </tr>
                </table>

                <!-- FIRMA -->
                <div style="margin-top: 40px; font-size: 9pt;">
                    <p>CONTADOR: <t t-esc="docs[0].contador_name or '________________________________'"/>
                    </p>
                    <p>FIRMA: ________________________________</p>
                </div>
            </div>
        </t>
    </template>
</data>
</odoo>
